"use strict";(self.webpackChunkaudiovisual=self.webpackChunkaudiovisual||[]).push([[59],{59:(e,t,s)=>{s.r(t),s.d(t,{default:()=>j});var n=s(168),i=s(540),a=s(556),r=s(578),o=s(38),l=s(488),c=s(942),u=s.n(c);const m=window.AudioContext||window.webkitAudioContext;class h{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!(e instanceof HTMLMediaElement))throw new Error("Spectral audio must be an HTMLMediaElement");e.pause();const{bufsize:s=8192,smoothing:n=.8,delay:i=.25}=t,a=new m;Object.defineProperties(this,{_audio:{value:e},context:{value:a},analyser:{value:a.createAnalyser()},gain:{value:a.createGain()},source:{value:a.createMediaElementSource(e)},delay:{value:a.createDelay(1)},_onCanPlay:{value:this._onCanPlay.bind(this)},_audioPlaying:{value:!1,writable:!0},_streamId:{value:null,writable:!0},_streamSources:{value:Object.create(null)}}),this.setupDelay(i),this.setupAnalyser(s,n),this.setupConnections(),e.addEventListener("canplay",this._onCanPlay)}close(){const{_audio:e,context:t,_onCanPlay:s}=this;e.removeEventListener("canplay",s),t.close&&t.close()}setupDelay(e){this.delay.delayTime.value=e}setupAnalyser(e,t){const{analyser:s}=this;s.fftSize=e,s.smoothingTimeConstant=t,s.getFloatTimeDomainData||(s.getFloatTimeDomainData=function(e){const t=new window.Uint8Array(this.fftSize);this.getByteTimeDomainData(t);for(let s=0;s<t.length;s++)e[s]=(t[s]-128)/128;return e})}setupConnections(){const{context:e,analyser:t,gain:s,delay:n,source:i}=this;i.connect(t),t.connect(s),s.connect(n),n.connect(e.destination)}_onCanPlay(){this._audioPlaying&&this._audio.paused&&this._audio.play()}get streaming(){return null!==this._streamId}get paused(){return!this.streaming&&!this._audioPlaying}addStream(e){const{id:t}=e,{context:s,_streamSources:n}=this;t in n||(n[t]=s.createMediaStreamSource(e))}removeStream(e){delete this._streamSources[e.id]}_startStream(e){const{source:t,analyser:s,_streamSources:n}=this;t.disconnect(),s.disconnect(),this.addStream(e),n[e.id].connect(s),this._streamId=e.id}_stopStream(){const{_streamId:e}=this;if(!e)return;const{source:t,analyser:s,gain:n,_streamSources:i}=this;i[e].disconnect(),delete i[e],this._streamId=null,t.connect(s),s.connect(n)}async play(e){const{_audio:t}=this;await this.context.resume(),e&&!this.streaming?(t.pause(),this._startStream(e)):!e&&t.paused&&(this._stopStream(),t.play(),this._audioPlaying=!0)}async pause(){this.paused||(this._stopStream(),this._audio.pause(),this._audioPlaying=!1,await this.context.suspend())}get gain(){return this.gain.gain.value}set gain(e){this.gain.gain.value=e}get waveformSize(){return this.analyser.fftSize}get spectrumSize(){return this.analyser.frequencyBinCount}get spectrumMin(){return this.analyser.minDecibels}get spectrumMax(){return this.analyser.maxDecibels}fillWaveform(e){return this.analyser.getFloatTimeDomainData(e)}fillSpectrum(e){return this.analyser.getFloatFrequencyData(e)}}const d={audiovisual:"audiovisual-gwAcJ",bgImage:"bgImage-Tph40",visualiser:"visualiser-NUZH_",progressContainer:"progressContainer-HogWF",progress:"progress-uJHrG",waveZero:"waveZero-QyPUL",fade:"fade-FwUKM",fadeIn:"fadeIn-CjBnr",fadeInActive:"fadeInActive-TGOxN",fadeOut:"fadeOut-JurT0",fadeOutActive:"fadeOutActive-zxe00",fadeOutScale:"fadeOutScale-nVwZc",fadeOutScaleTransition:"fadeOutScaleTransition-VrhbX",fadeOutScaleTransitionActive:"fadeOutScaleTransitionActive-b3AUV",play:"play-RiQmw",pause:"pause-ZnvQq"};function p(e,t,s){if(s-t<=1)return e[t];let n=0;for(let i=t;i<s;i++)n+=e[i];return n/(s-t)}function g(e,t){return(Math.pow(e,t)-1)/(e-1)}function f(e,t,s){return Math.min(Math.floor(g(100,s/t)*e),e)}function v(e){const{children:t,...s}=e,a=u()(t.props.className,d.fade),r=i.cloneElement(t,{className:a});return i.createElement(l.A,(0,n.A)({},s,{classNames:{appear:d.fadeIn,appearActive:d.fadeInActive,enter:d.fadeIn,enterActive:d.fadeInActive,exit:d.fadeOut,exitActive:d.fadeOutActive},timeout:500}),r)}function y(e){const{children:t,...s}=e,a=u()(t.props.className,d.fadeOutScale),r=i.cloneElement(t,{className:a});return i.createElement(l.A,(0,n.A)({},s,{classNames:{appear:d.fadeOutScaleTransition,appearActive:d.fadeOutScaleTransitionActive,enter:d.fadeOutScaleTransition,enterActive:d.fadeOutScaleTransitionActive},timeout:500}),r)}function w(e){const{textColor:t,className:s}=e;return i.createElement("div",{className:u()(d.pause,s),style:{borderLeftColor:t,borderRightColor:t}})}function E(e){const{textColor:t,className:s}=e;return i.createElement("div",{className:u()(d.play,s),style:{borderLeftColor:t}})}function C(e){const{bgURL:t}=e,s=t?`url('${t}')`:"none";return i.createElement(o.A,null,i.createElement(v,{key:s},i.createElement("div",{className:d.bgImage,style:{backgroundImage:s}})))}v.propTypes={children:a.element},y.propTypes={children:a.element},w.propTypes={textColor:a.string.isRequired,className:a.string},E.propTypes={textColor:a.string.isRequired,className:a.string},C.propTypes={bgURL:a.string};class R extends i.Component{static get propTypes(){return{className:a.string,src:a.string,stream:(0,a.instanceOf)(MediaStream),playing:a.bool,updating:a.bool,numFreq:a.number,numWave:a.number,waveWidth:a.number,freqColor:a.string,waveColor:a.string,shadowColor:a.string,shadowBlur:a.number,bgURL:a.string,bgColor:a.string,textColor:a.string,altColor:a.string,onEnded:a.func,onKeyDown:a.func,tabIndex:a.number}}static get defaultProps(){return{numFreq:128,numWave:1024,waveWidth:3,freqColor:"white",waveColor:"rgb(0%, 50%, 100%)",shadowColor:"black",shadowBlur:8,bgColor:"transparent",textColor:"rgba(100%, 100%, 100%, 0.8)",altColor:"rgba(100%, 100%, 100%, 0.1)"}}constructor(e){super();const{numFreq:t,numWave:s}=e;this.audio=null,this.spectral=null,this.node=null,this.canvas=null,this.progress=null,this.animFrame=null,this.waveform=null,this.spectrum=null,this.waveXs=new Float32Array(s),this.waveYs=new Float32Array(s),this.freqXs=new Float32Array(t),this.freqYs=new Float32Array(t),this.state={offsetWidth:1,offsetHeight:1},["audioRef","nodeRef","canvasRef","progressRef","onAnimFrame","onTimeUpdate","onResize"].forEach((e=>{this[e]=this[e].bind(this)}))}onTimeUpdate(e){const t=e.target.currentTime/e.target.duration;this.progress&&(this.progress.style.width=100*t+"%")}onResize(){const{offsetWidth:e,offsetHeight:t}=this.node;if(e!==this.state.offsetWidth){const{numFreq:t,numWave:s}=this.props,{freqXs:n,waveXs:i}=this,a=e/t;for(let e=0,s=a;e<t;e++,s+=a)n[e]=s;const r=e/s;for(let e=0,t=0;e<s;e++,t+=r)i[e]=t;this.setState({offsetWidth:e})}t!==this.state.offsetHeight&&this.setState({offsetHeight:t})}initSpectral(e){const{playing:t,updating:s,stream:n}=this.props;this.audio=e,e.addEventListener("timeupdate",this.onTimeUpdate);const i=this.spectral=new h(e);this.waveform=new Float32Array(i.waveformSize),this.spectrum=new Float32Array(i.spectrumSize/2),t&&this.spectral.play(n),t&&s&&this.startAnimating()}destroySpectral(){this.stopAnimating(),this.waveform=null,this.spectrum=null,this.spectral.close(),this.spectral=null,this.audio.removeEventListener("timeupdate",this.onTimeUpdate),this.audio=null}audioRef(e){this[null===e?"destroySpectral":"initSpectral"](e)}nodeRef(e){this.node=e,e?(window.addEventListener("resize",this.onResize),this.onResize()):window.removeEventListener("resize",this.onResize)}canvasRef(e){this.canvas=e?e.getContext("2d"):null}progressRef(e){this.progress=e}onAnimFrame(){const{canvas:e}=this;if(!e)return;const{offsetWidth:t,offsetHeight:s}=this.state;e.clearRect(0,0,t,s),this.updateWave(e),this.updateFreq(e),this.animFrame=requestAnimationFrame(this.onAnimFrame)}updateWave(e){const{spectral:t,waveform:s,waveXs:n,waveYs:i}=this;t.fillWaveform(s);const{waveformSize:a}=t,{numWave:r,waveColor:o,waveWidth:l,shadowColor:c,shadowBlur:u}=this.props,{offsetHeight:m}=this.state,h=a/r;for(let e=0;e<r;e++)i[e]=(p(s,e*h,(e+1)*h)/6+.5)*m;e.beginPath(),e.strokeStyle=o,e.shadowColor=c,e.shadowBlur=u,e.lineWidth=l,function(e,t,s,n){if(t<3)return;let i=s[0],a=n[0],r=s[0],o=n[0],l=s[1],c=n[1],u=s[2],m=n[2];e.moveTo(r,o),b(e,i,a,i,a,l,c,u,m);for(let h=1;h<t-2;h++)b(e,i,a,r,o,l,c,u,m),i=r,a=o,r=l,o=c,l=u,c=m,u=s[h+2],m=n[h+2];b(e,s[t-3],n[t-3],s[t-2],n[t-2],s[t-1],n[t-1],s[t-1],n[t-1])}(e,r,n,i),e.stroke()}updateFreq(e){const{spectral:t,spectrum:s,freqXs:n,freqYs:i}=this,a=s.length;t.fillSpectrum(s);const{spectrumMin:r,spectrumMax:o}=t,{numFreq:l,freqColor:c,shadowColor:u,shadowBlur:m}=this.props,{offsetWidth:h,offsetHeight:d}=this.state,v=o-r;for(let e=0;e<a;e++){const t=g((a-e)/a*v,(s[e]-r)/v);s[e]=Math.min(Math.max(t,0),1)}const y=d/3;for(let e=0;e<l;e++)i[e]=d-p(s,f(a,l,e),f(a,l,e+1))*y;e.beginPath(),e.fillStyle=c,e.shadowColor=u,e.shadowBlur=m,e.moveTo(0,d),function(e,t,s,n,i){const a=e.canvas.height;for(let s=0,r=0;s<t;s++){const t=n[s],o=i[s];e.lineTo(r,a),e.lineTo(r,o),e.lineTo(t-.5,o),e.lineTo(t-.5,a),r=t}}(e,l,0,n,i),e.lineTo(h,d),e.closePath(),e.fill()}startAnimating(){null===this.animFrame&&(this.animFrame=requestAnimationFrame(this.onAnimFrame))}stopAnimating(){null!==this.animFrame&&(cancelAnimationFrame(this.animFrame),this.animFrame=null)}componentDidUpdate(e){const{playing:t,numFreq:s,numWave:n,updating:i,stream:a}=this.props;s!==e.numFreq&&(this.freqPoints=new Float32Array(s)),n!==e.numWave&&(this.wavePoints=new Float32Array(n)),this.spectral&&(t?this.spectral.play(a):this.spectral.pause(),t&&i?this.startAnimating():this.stopAnimating())}render(){const{className:e,waveWidth:t,bgURL:s,bgColor:n,altColor:a,textColor:r,src:l,stream:c,playing:m,onEnded:h,onKeyDown:p,tabIndex:g}=this.props,f=u()(d.audiovisual,e),v={backgroundColor:n};if(!l&&!c)return i.createElement("div",{className:f,style:v});const{offsetWidth:R,offsetHeight:b}=this.state,{nodeRef:_,audioRef:S,progressRef:I,canvasRef:k}=this,T={backgroundColor:a,height:t,bottom:(b-t)/2},A=m?i.createElement(E,{textColor:r}):i.createElement(w,{textColor:r});return i.createElement("div",{className:f,style:v,onKeyDown:p,tabIndex:g,ref:_},i.createElement(C,{bgURL:s}),i.createElement("audio",{src:c?void 0:l,ref:S,onEnded:h}),i.createElement("div",{className:d.waveZero,style:T}),i.createElement("div",{className:d.progressContainer,style:{backgroundColor:a}},i.createElement("div",{ref:I,className:d.progress,style:{backgroundColor:r}})),i.createElement("canvas",{ref:k,className:d.visualiser,width:R,height:b}),i.createElement(o.A,null,i.createElement(y,{key:m?"play":"pause"},A)))}}function b(e,t,s,n,i,a,r,o,l){const c=(6*n-t+a)/6,u=(6*i-s+r)/6,m=(n+6*a-o)/6,h=(i+6*r-l)/6;e.bezierCurveTo(c,u,m,h,a,r)}var _=s(118),S=s.n(_);const I={jpg:"image/jpeg",png:"image/png","image/jpeg":"image/jpeg","image/png":"image/png"};function k(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"/";return e.match(new RegExp(`[^${t}]*$`))[0]}class T{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this._url=e.url||null,this._file=null,this._fileURL=null,this._parsedTags=!1,this._artist=e.artist,this._album=e.album,this._title=e.title,this.file=e.file||null}cleanup(){this._fileURL&&URL.revokeObjectURL(this._fileURL),this._pictureURL&&URL.revokeObjectURL(this._pictureURL)}get url(){return this._url||this._fileURL}get fileURL(){return this._fileURL}set file(e){if(e!==this._file)if(this._fileURL&&(URL.revokeObjectURL(this._fileURL),this._url=null),null!==e){if(!(e instanceof File))throw new Error(`AudioFile#file must be a File or null, got: ${e}`);this._file=e,this._fileURL=URL.createObjectURL(e)}else this._file=null}get file(){return this._file}get parsedTags(){return this._parsedTags}get artist(){return this._artist||"no artist"}get album(){return this._album||"no album"}get title(){if(this._title)return this._title;const{file:e}=this;return e&&e.name?k(e.name,":"):k(this.url)}get pictureURL(){return this._pictureURL}get pictureType(){return this._pictureType}get pictureSizes(){return this._pictureSizes}addPictureFromTag(e){if(!e)return;const{data:t,format:s}=e,n=Uint8Array.from(t),i=I[s.toLowerCase()],a=new Blob([n],{type:i}),r=URL.createObjectURL(a);return new Promise(((e,t)=>{const s=document.createElement("img");s.onload=()=>{const{width:t,height:n}=s;this._pictureType=i,this._pictureURL=r,this._pictureSizes=`${t}x${n}`,e()},s.onerror=e=>{URL.revokeObjectURL(r),t(e)},s.src=r}))}async addTags(){const{file:e}=this;if(this.parsedTags||!e||!/\.(mp3|mp4|m4a)$/.test(e.name))return this;let t;try{t=await new Promise(((t,s)=>{S().read(e,{onSuccess:e=>t(e.tags),onError:s})}))}catch(e){throw console.error("failed to parse tags",e),e}return["artist","album","title"].forEach((e=>{e in t&&(this[`_${e}`]=t[e])})),await this.addPictureFromTag(t.picture),this._parsedTags=!0,this}}class A{constructor(e){if(!e)throw new Error("Cannot construct AudioStream without data");if(!(e.stream instanceof MediaStream))throw new Error(`data.stream must be a MediaStream, got: ${e.stream}`);this._stream=e.stream,this._title=e.title}cleanup(){const{stream:e}=this;e.getTracks().forEach((t=>{t.stop(),e.removeTrack(t)}))}get stream(){return this._stream}get title(){const{_title:e}=this;if(e)return e;const{stream:t}=this,s=t.getAudioTracks();if(s.length){const{label:e}=s[0];if(e)return e}return`Audio stream ${t.id}`}}class x{constructor(){this._items=[],this._hist=[],this._histIndex=null}get itemsLength(){return this._items.length}get items(){return this._items}get item(){const{_histIndex:e,_hist:t}=this;return null===e?null:t[e]}set item(e){this._hist.unshift(e),this._histIndex=0}nextItem(e){const{_histIndex:t}=this;if(t>0)return this._histIndex--,this.item;const{item:s,_items:n}=this,i=null===s?0:n.indexOf(s),{length:a}=n,r=n[(i+(e?Math.floor(Math.random()*(a-1))+1:1))%a];return this._hist.unshift(r),this._histIndex=0,r}prevItem(){return this._histIndex+1>=this._hist.length||this._histIndex++,this.item}addItems(e){this._items=this._items.concat(e)}removeItem(e){const t=this.item,s=t=>t!==e;if(this._hist=this._hist.filter(s),this._items=this._items.filter(s),null!==t&&t!==e){const{_hist:e,_histIndex:s}=this;e[s]!==t&&(this._histIndex=e.indexOf(t))}}}const F={compact:"compact-sQJve",picture:"picture-mq4WL",details:"details-eOd1v",title:"title-yhBRj",items:"items-F1GQs",search:"search-RRfzX",actions:"actions-n80RP",itemsContainer:"itemsContainer-Y3TLX",item:"item-Z3gxD",remove:"remove-oGSJf",selected:"selected-OsuiC"},L=(0,a.oneOfType)([T,A].map(a.instanceOf));function U(e){e.stopPropagation()}function q(e){const{file:t,selected:s,onClick:n,onRemove:a}=e,r=u()(F.item,{[F.selected]:s}),o=function(e){const{artist:t,album:s,title:n}=e;return`${t} · ${s} · ${n}`}(t),l=a?i.createElement("span",{key:"remove",className:F.remove,onClick:a},"×"):null;return i.createElement("p",{className:r,title:e.title},i.createElement("span",{onClick:n},o),l)}function N(e){const{stream:t,selected:s,onClick:n,onRemove:a}=e,r=u()(F.item,{[F.selected]:s}),{title:o}=t,l=a?i.createElement("span",{key:"remove",className:F.remove,onClick:a},"×"):null;return i.createElement("p",{className:r,title:e.title},i.createElement("span",{onClick:n},o),l)}function M(e){const{addMicrophone:t,onInputFiles:s,toggle:n}=e;return i.createElement("span",{className:F.actions},i.createElement("span",{onClick:t,title:"add microphone"},"●"),i.createElement("label",{title:"add songs"},"+",i.createElement("input",{type:"file",accept:"audio/*",multiple:!0,onChange:s})),i.createElement("span",{onClick:n,title:"close"},"×"))}function O(e){const{toggle:t,item:s}=e;function n(e){U(e),t()}if(!s)return i.createElement("div",{className:F.compact,onClick:n,title:"select a song"},i.createElement("span",{className:F.title},"No song selected."));const{artist:a,album:r,title:o,pictureURL:l}=s,c=l?i.createElement("img",{className:F.picture,src:l,alt:"album art"}):i.createElement("div",{className:F.picture},"no album art"),u=a?i.createElement("span",{className:F.artist},a):null,m=r?i.createElement("span",{className:F.album},r):null,h=i.createElement("span",{className:F.title},o);return i.createElement("div",{className:F.compact,onClick:n,title:"select a song"},c,i.createElement("div",{className:F.details},h,m,u))}q.propTypes={file:(0,a.instanceOf)(T).isRequired,selected:a.bool,onClick:a.func,onRemove:a.func,title:a.string},N.propTypes={stream:(0,a.instanceOf)(A).isRequired,selected:a.bool,onClick:a.func,onRemove:a.func,title:a.string},M.propTypes={onInputFiles:a.func.isRequired,addMicrophone:a.func.isRequired,toggle:a.func.isRequired},O.propTypes={item:L,toggle:a.func.isRequired};class P extends i.Component{static get propTypes(){return{history:(0,a.instanceOf)(x).isRequired,onInputFiles:a.func.isRequired,removeItem:a.func.isRequired,setItem:a.func.isRequired,addMicrophone:a.func.isRequired}}constructor(){super(),this.state={search:"",filter:null,showing:!1},this.toggle=this.toggle.bind(this),this.onSearchChange=this.onSearchChange.bind(this),this.searchRef=i.createRef()}toggle(){this.setState({showing:!this.state.showing})}onSearchChange(e){const{value:t}=e.target,s=new RegExp(t.replace(/\s/g,"\\s*"),"i");this.setState({search:t,filter:s})}componentDidUpdate(e,t){if(this.state.showing&&!t.showing){const e=this.searchRef.current;e.focus(),e.select()}}render(){const{history:e}=this.props,{showing:t}=this.state,{toggle:s}=this,{item:n}=e;if(!t)return i.createElement(O,{item:n,toggle:s});const{onInputFiles:a,addMicrophone:r,removeItem:o,setItem:l}=this.props,{search:c,filter:u}=this.state,{items:m}=e,h=(u?m.filter((e=>function(e,t){const{album:s,artist:n,title:i}=t;return e.test(`${n} ${s} ${i}`)}(u,e))):m).map((e=>{function t(){s(),l(e)}function a(){o(e)}if(e instanceof T)return i.createElement(q,{key:e.url,file:e,selected:e===n,onClick:t,onRemove:a});if(e instanceof A)return i.createElement(N,{key:e.stream.id,stream:e,selected:e===n,onClick:t,onRemove:a});throw new Error("Item of unknown type in item list")}));return i.createElement("div",{className:F.items,onClick:U},i.createElement("div",{className:F.search},i.createElement("input",{type:"search",placeholder:"search",value:c,onChange:this.onSearchChange,ref:this.searchRef}),i.createElement(M,{onInputFiles:a,addMicrophone:r,toggle:s})),i.createElement("div",{className:F.itemsContainer},h))}}function z(e){e.stopPropagation()}function D(e){return i.createElement("div",{className:"help-asfnr",onClick:e.onClick},i.createElement("table",null,i.createElement("tbody",null,i.createElement("tr",null,i.createElement("td",null,"V"),i.createElement("td",null,"visualisation on/off")),i.createElement("tr",null,i.createElement("td",null,"S"),i.createElement("td",null,"shuffle on/off")),i.createElement("tr",null,i.createElement("td",null,"R"),i.createElement("td",null,"repeat on/off")),i.createElement("tr",null,i.createElement("td",null,"J, ←"),i.createElement("td",null,"previous song")),i.createElement("tr",null,i.createElement("td",null,"K, space, click"),i.createElement("td",null,"play/pause")),i.createElement("tr",null,i.createElement("td",null,"L, →"),i.createElement("td",null,"next song")),i.createElement("tr",null,i.createElement("td",{colSpan:"2"},"Click the song info to select a song.")))))}D.propTypes={onClick:a.func};class H extends i.Component{static get propTypes(){return{updating:a.bool,shuffle:a.bool,repeat:a.bool,playing:a.bool,toggleUpdating:a.func.isRequired,toggleShuffle:a.func.isRequired,toggleRepeat:a.func.isRequired,togglePlaying:a.func.isRequired,prevItem:a.func.isRequired,nextItem:a.func.isRequired}}constructor(){super(),this.state={showingHelp:!1},this.toggleHelp=this.toggleHelp.bind(this)}toggleHelp(){this.setState({showingHelp:!this.state.showingHelp})}render(){const{updating:e,shuffle:t,repeat:s,playing:n,toggleUpdating:a,toggleShuffle:r,toggleRepeat:o,togglePlaying:l,nextItem:c,prevItem:u}=this.props,{showingHelp:m}=this.state,{toggleHelp:h}=this,d=m?i.createElement(D,{onClick:h}):null;return i.createElement("div",{className:"controls-YCJN4",onClick:z},i.createElement("div",{className:"playback-AFalc"},i.createElement("div",null,i.createElement("span",{onClick:a,title:"visualisation on/off"},e?"V":"v"),i.createElement("span",{onClick:r,title:"shuffle on/off"},t?"S":"s"),i.createElement("span",{onClick:o,title:"repeat on/off"},s?"R":"r")),i.createElement("div",null,i.createElement("span",{onClick:u,title:"previous song"},"⏮"),i.createElement("span",{onClick:l,title:"play/pause"},n?"॥":"►"),i.createElement("span",{onClick:c,title:"next song"},"⏭"),i.createElement("span",{onClick:h,title:"help"},"?"))),d)}}const W="container-B97Iv";function $(e){const{onInputFiles:t,addMicrophone:s}=e;return i.createElement("div",{className:W},i.createElement("div",{className:"fileInput-yLtd2"},i.createElement("h1",{onClick:s},"Click here to use your microphone!"),i.createElement("label",null,i.createElement("h1",null,"Click here to select some songs to play!"),i.createElement("input",{type:"file",accept:"audio/*",multiple:!0,onChange:t})),i.createElement("h3",null,"(Hint: you can select multiple files)"),i.createElement("h4",null,"(Loading mp3 files can take a while, please be patient!)"),i.createElement("h5",null,i.createElement("a",{href:"https://github.com/aspyrx/audiovisual"},"Source code on GitHub"),i.createElement("span",null," made by "),i.createElement("a",{href:"https://szz.io/"},"Stan Zhang"))))}$.propTypes={addMicrophone:a.func.isRequired,onInputFiles:a.func.isRequired};class j extends i.Component{constructor(){super(),this.state={loading:!1,playing:!0,repeat:!1,shuffle:!0,updating:!0,history:new x},["playing","repeat","shuffle","updating"].forEach((e=>{this[`toggle${e[0].toUpperCase()+e.slice(1)}`]=()=>{this.setState({[e]:!this.state[e]})}})),["onInputFiles","onKeyDown","addMicrophone","removeItem","setItem","nextItem","prevItem"].forEach((e=>{this[e]=this[e].bind(this)})),this.keyHandlers={" ":this.togglePlaying,ArrowLeft:this.prevItem,ArrowRight:this.nextItem,j:this.prevItem,k:this.togglePlaying,l:this.nextItem,r:this.toggleRepeat,s:this.toggleShuffle,v:this.toggleUpdating}}request(e,t,s){return new Promise(((n,i)=>{const a=new XMLHttpRequest,r=()=>{this.setState({loading:!1},(()=>i(a)))};Object.assign(a,s),a.onreadystatechange=()=>{a.readyState===XMLHttpRequest.DONE&&(200===a.status?this.setState({loading:!1},(()=>n(a))):r())},a.onerror=r,a.open(e,t),a.send(),this.setState({loading:!0})}))}async requestAudioFile(e){if(e.file)return e;if(!e.url)throw new Error("Cannot request URL for AudioFile without URL");let t;try{t=await this.request("GET",e.url,{responseType:"blob"})}catch(t){throw new Error(`Failed to request audio file from '${e.url}'`)}const s=t.response;if(!(s instanceof Blob))throw new Error(`Malformed response to AudioRequest: '${s}'`);return e.file=new File([s],e.url,{type:s.type}),e}addItems(e){e.length<1||this.setState((t=>{let{history:s}=t;return s.addItems(e),{history:s}}),(()=>{this.state.history.item||this.nextItem()}))}async onInputFiles(e){const t=await Promise.all(Array.prototype.map.call(e.target.files,(e=>new T({file:e}).addTags())));this.addItems(t)}onKeyDown(e){const t=this.keyHandlers[e.key];t&&t(e)}removeItem(e){this.setState((t=>{let{history:s}=t;return s.removeItem(e),{history:s}}),(()=>{e.cleanup()}))}async setItem(e){if(e instanceof T)try{await this.requestAudioFile(e),await e.addTags()}catch(e){return}this.setState((t=>{let{history:s}=t;return s.item=e,{history:s}}))}async nextItem(){const{history:e,shuffle:t}=this.state,s=e.nextItem(t);s instanceof T&&(await this.requestAudioFile(s),await s.addTags()),this.setState({history:e})}prevItem(){this.setState((e=>{let{history:t}=e;return t.prevItem(),{history:t}}))}addMicrophone(){const e=e=>{const t=new A({stream:e}),s=e.getAudioTracks();s.length&&(s[0].addEventListener("ended",(()=>{this.removeItem(t)})),this.addItems([t]))};try{navigator.mediaDevices.getUserMedia({audio:!0}).then(e,console.log)}catch(t){(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia).call(navigator,{audio:!0},e,console.log)}}async componentDidMount(){if(window.document.addEventListener("keydown",this.onKeyDown),"mediaSession"in navigator){const{mediaSession:e}=navigator;for(const[t,s]of[["play",()=>this.setState({playing:!0})],["pause",()=>this.setState({playing:!1})],["previoustrack",this.prevItem],["nexttrack",this.nextItem]])try{e.setActionHandler(t,s)}catch(e){}}let e;try{e=await this.request("GET","/audio/.audiovisual.json")}catch(e){return}const t=JSON.parse(e.responseText);if(!(t instanceof Array))return;this.setState({playing:!1});const s=t.map((e=>new T(e)));this.addItems(s)}componentWillUnmount(){window.document.removeEventListener("keydown",this.onKeyDown)}async componentDidUpdate(){if(!("mediaSession"in navigator))return;const{history:e,playing:t}=this.state,{item:s}=e;let n=null;if(s instanceof T){const{artist:e,album:t,title:i,pictureURL:a,pictureType:r,pictureSizes:o}=s;n={artist:e,album:t,title:i},a&&(n.artwork=[{src:a,sizes:o,type:r}])}else if(s instanceof A){const{title:e}=s;n={title:e}}const{mediaSession:i}=navigator;n?(i.metadata=new window.MediaMetadata(n),i.playbackState=t?"playing":"paused"):(i.metadata=null,i.playbackState="none")}render(){const{shuffle:e,repeat:t,updating:s,playing:a,loading:o,history:l}=this.state,{togglePlaying:c,toggleShuffle:u,toggleRepeat:m,toggleUpdating:h,onInputFiles:d,addMicrophone:p,removeItem:g,setItem:f,nextItem:v,prevItem:y}=this;if(!l.itemsLength)return i.createElement($,{addMicrophone:p,onInputFiles:d});const w={updating:s,playing:a&&!o,onEnded:v,tabIndex:-1},{item:E}=l;E instanceof T?(w.src=E.fileURL,w.bgURL=E.pictureURL):E instanceof A&&(w.stream=E.stream);const C=o?i.createElement(r.A,null):null,b={history:l,onInputFiles:d,addMicrophone:p,removeItem:g,setItem:f},_={repeat:t,shuffle:e,updating:s,playing:a,toggleRepeat:m,toggleShuffle:u,toggleUpdating:h,togglePlaying:c,prevItem:y,nextItem:v};return i.createElement("div",{className:W,onClick:c},C,i.createElement(R,(0,n.A)({className:"audiovisual-r9VBU"},w)),i.createElement("div",{className:"itemsContainer-zrBSz"},i.createElement(P,b)),i.createElement(H,_))}}}}]);